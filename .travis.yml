language: cpp

matrix:
  include:
    - compiler: g++-5
      sudo: required
      dist: trusty
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - g++-5
            - lua5.2
            - liblua5.2-dev
      before_install:
        - sudo apt-get autoremove lua lua5.1
      install:
        - sudo apt-get install -y gdb
        - sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-5 30
      after_failure:
        - COREFILE=$(find . -maxdepth 1 -name "core*" | head -n 1) # find core file
        - if [[ -f "$COREFILE" ]]; then gdb -c "$COREFILE" ./tests -ex "thread apply all bt" -ex "set pagination 0" -batch; fi
      before_script:
        - ulimit -c unlimited -S
      script:
        - export BUILD_TYPES="debug release"
        - for build_type in $BUILD_TYPES; do
        -   build_dir = $build_type
        -   mkdir $build_dir
        -   (cd $build_dir && cmake -DCMAKE_BUILD_TYPE=$build_type -DLUA_INCLUDE_DIR="/usr/include/lua5.2" -DLUA_LIBRARY="/usr/lib/x86_64-linux-gnu/liblua5.2.so"  ..)
        -   (cd $build_dir && make -j5 install)
        -   (cd $build_dir && ./tests && ./run_tests.lua)
        - done

    - compiler: clang
      os: osx
      osx_image: xcode8.2
      before_install:
        - brew update
      install:
        - brew install lua
      script:
        - export BUILD_TYPES="debug release"
        - for build_type in $BUILD_TYPES; do
        -   build_dir = $build_type
        -   mkdir $build_dir
        -   (cd $build_dir && cmake -DCMAKE_BUILD_TYPE=$build_type .. && make -j5 install)
        -   (cd $build_dir && ./tests && ./run_tests.lua)
        - done
